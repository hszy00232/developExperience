## 微信小程序开发相关资源
[wepy文档](https://tencent.github.io/wepy/document.html)
[wepy使用介绍](http://dev.qq.com/topic/5844d6947badb2796037f9e3)
[微信小程序API](https://mp.weixin.qq.com/debug/wxadoc/dev/api/)

## 使用wepy new project命令生成的项目运行出错

VM8634:1 thirdScriptError 
 sdk uncaught third Error 
 Cannot set property 'Promise' of undefined 
 TypeError: Cannot set property 'Promise' of undefined
 
VM8634:1 thirdScriptError 
 sdk uncaught third Error 
 Cannot read property '$pages' of undefined 
 TypeError: Cannot read property '$pages' of undefined
 
 解决方法：开发者工具 -> 设置 -> 项目设置 关闭ES6转ES5
 
 ## 使用wepy.request时报错
 
Cannot read property 'then' of undefined;

解决方法：

app.wpy文件中

```
constructor () {
  super()
  this.use('promisify')
  this.use('requestfix')
}
```

## dist目录中不需要的文件不会自动删除，可以使用npm run clean

package.json配置如下：

```
"clean": "find ./dist -maxdepth 1 -not -name 'project.config.json' -not -name 'dist' | xargs rm -rf",
```

## url参数总长度不能超过30个字节，否则会被截断

## 转发功能

通过给 button 组件设置属性 open-type="share"，可以在用户点击按钮后触发 Page.onShareAppMessage() 事件，如果当前页面没有定义此事件，则点击后无效果。

```
<button class="share-btn" open-type="share">邀请好友答题</button>
// 分享给朋友
onShareAppMessage() {
  ...
  // 请求异步接口
  
  let shareInfoConf = this.settingsConf.shareInfo
  let titleLen = shareInfoConf.title.length
  let index = Math.floor(Math.random() * titleLen) || 0
  let title = shareInfoConf.title[index]
  this.$apply()

  return {
    ...shareInfoConf,
    title: title,
    path: `pages/hongbao/answer/index?q=${this.questId}`
  }
};

```
## 发送模板消息（订阅通知）

[API地址](https://mp.weixin.qq.com/debug/wxadoc/dev/api/notice.html)

![image](https://p4.ssl.qhimg.com/t011502a2e8a17e52fe.jpg)

![image](https://p3.ssl.qhimg.com/t019865ae6e47a93e25.jpg)

![image](https://p3.ssl.qhimg.com/t014eaccea43de83677.jpg)

第一步：获取模板ID

第二步：使用`<form/>`组件，属性`report-submit`为`true`时，可以声明为需发模板消息，此时点击按钮提交表单可以通过`event.detail.formId`获取`formId`，用于发送模板消息。或者当用户完成支付行为，可以获取`prepay_id`用于发送模板消息。**注意：** `formId`只能在手机上才能取到，使用开发工具取不到

第三步：调用接口下发模板消息



## 图片上传

选取图片：

[选取图片API地址](https://mp.weixin.qq.com/debug/wxadoc/dev/api/media-picture.html#wxchooseimageobject)

```
async chooseImage (method) {
  const image = await wepy.chooseImage({
    count: 1
  })
  let size = image.tempFiles[0].size / Math.pow(1024, 2)

  // 图片超过2MB时不可以提交
  if (size.toFixed(2) > 2) {
    wx.showToast({
      title: '图片不能超过2MB',
      duration: 1000
    })
    return
  }
  this.imgPath = image.tempFilePaths[0]
  this.$apply()
}
```

图片上传

[选取图片API地址](https://mp.weixin.qq.com/debug/wxadoc/dev/api/network-file.html)

```
uploadImage (filePath) {
    const userInfo = wepy.getStorageSync('user_info')
    return wepy.uploadFile({
      url: `${Conf.apiUrl}/image/upload`,
      name: 'image',
      filePath,
      header: {
        'content-type': 'multipart/form-data',
        'Cookie': `token=${userInfo.token}`
      }
    })
}
```

踩到的坑：

iphone在某些情况下通过相机选取图片后，会把页面撑大，横向出现滚动条，从视觉上看像是宽高尺寸进行了对调。

临时的解决方案是，page尺寸定死，不用默认或100%，这种解决方案只是解决了page，但view仍然尺寸还是有问题的，所以横向还是有滚动条。
